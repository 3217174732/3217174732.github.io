<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>M3U8æ’­æ”¾å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        body {
            background: #f5f7fa;
            padding: 16px;
            min-height: 100vh;
        }
        .page-header {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #333;
        }
        .config-group {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .config-item {
            margin-bottom: 16px;
        }
        .config-item:last-child {
            margin-bottom: 0;
        }
        .config-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 6px;
            display: block;
        }
        .config-input {
            width: 100%;
            height: 44px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: #fafafa;
        }
        .config-input:focus {
            outline: none;
            border-color: #2196f3;
            background: #fff;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        .btn {
            flex: 1;
            height: 44px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-start {
            background: #2196f3;
            color: #fff;
        }
        .btn-start:hover {
            background: #1976d2;
        }
        .btn-toggle {
            background: #e5e7eb;
            color: #666;
        }
        .btn-toggle:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            color: #ccc;
        }
        .stats-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .stats-card {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stats-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        .stats-value {
            font-size: 18px;
            font-weight: 600;
            color: #2196f3;
        }
        .video-player {
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 16px;
            min-height: 200px;
        }
        #video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        /* é¢„åŠ è½½åŠ¨ç”»è¦†ç›–å±‚ - å›ºå®šä¸æ—‹è½¬ */
        .preload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: opacity 0.5s ease;
        }
        .preload-animation {
            width: 80px;
            height: 80px;
            background-image: url('https://qacommunity-70502.njc.vod.tencent-cloud.com/504046ff-7f45-4e44-835f-4ad25a585358.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ–°æ ·å¼æ§åˆ¶æ  */
        .video-controls {
            width: 100%;
            padding: 8px 12px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            position: absolute;
            bottom: 0;
            left: 0;
            color: #fff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .control-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .time-display {
            font-size: 13px;
            color: #fff;
            font-weight: 400;
        }
        .control-buttons {
            display: flex;
            gap: 8px;
        }
        .control-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        .progress-bar {
            width: 100%;
            height: 2px;
            background: rgba(255,255,255,0.3);
            border-radius: 1px;
            cursor: pointer;
            position: relative;
        }
        .progress-now {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: #fff;
            border-radius: 1px;
            width: 0;
        }

        /* ä¸‰ç‚¹èœå•ä¸‹æ‹‰ */
        .more-menu {
            position: absolute;
            bottom: 40px;
            right: 12px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 120px;
            display: none;
            z-index: 11;
        }
        .more-menu.active {
            display: block;
        }
        .menu-item {
            color: #fff;
            font-size: 13px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .speed-options {
            padding: 4px 0;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .speed-option {
            color: #fff;
            font-size: 12px;
            padding: 6px 16px;
            cursor: pointer;
        }
        .speed-option.active {
            color: #2196f3;
            background: rgba(33,150,243,0.2);
        }
        .speed-option:hover {
            background: rgba(255,255,255,0.1);
        }

        /* å…¨å±ä¸“å±æ©™è‰²æš‚åœå›¾æ ‡ï¼šä»…å…¨å±æ˜¾ç¤ºï¼Œç½‘é¡µç«¯éšè— */
        .fullscreen-pause-btn {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            border: none;
            color: #ff9800;
            font-size: 48px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        /* å…¨å±çŠ¶æ€ä¸‹æ˜¾ç¤ºæ©™è‰²æš‚åœæŒ‰é’® */
        body:fullscreen .fullscreen-pause-btn,
        body:-webkit-full-screen .fullscreen-pause-btn,
        body:-moz-full-screen .fullscreen-pause-btn,
        body:ms-fullscreen .fullscreen-pause-btn {
            display: flex;
        }

        /* 1å·æ¡†ï¼šæ—¥å¿—é¢æ¿ - ç§»é™¤è¯¦ç»†æ ‡è¯†ï¼Œä»…ä¿ç•™å›¾æ ‡ */
        .log-panel {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-height: 150px;
            max-height: 30vh;
            font-size: 12px;
            color: #666;
            line-height: 1.6;
            overflow-y: auto;
            margin: 16px 0;
            position: relative;
        }
        .log-panel::before {
            content: "ğŸ“‹";
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            padding: 4px 0 8px 0;
            font-weight: 500;
            color: #2196f3;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 8px;
            background: #fff;
            z-index: 1;
        }
        .log-panel .ts-log-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 4px 0;
            padding: 2px 0;
        }
        .copy-ts-btn {
            background: #2196f3;
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .copy-ts-btn:hover {
            background: #1976d2;
        }

        /* 2å·æ¡†ï¼šTSåˆ—è¡¨é¢æ¿ */
        .ts-list {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-height: 120px;
            max-height: 35vh;
            margin: 16px 0;
            overflow-y: auto;
            position: relative;
        }
        .ts-list::before {
            content: "ğŸ“ TSç‰‡æ®µåˆ—è¡¨";
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            padding: 4px 0 8px 0;
            font-weight: 500;
            color: #2196f3;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 8px;
            background: #fff;
            z-index: 1;
        }
        .ts-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .ts-item:last-child {
            border-bottom: none;
        }
        .ts-index {
            width: 36px;
            text-align: center;
            font-weight: 600;
            color: #2196f3;
        }
        .ts-url {
            flex: 1;
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0 8px;
        }
        .ts-extinf {
            font-size: 12px;
            color: #999;
            min-width: 90px;
            text-align: right;
            margin-right: 8px;
        }
        .copy-tip {
            color: #4CAF50;
            font-size: 10px;
            margin-left: 4px;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="page-header">M3U8æ’­æ”¾å™¨</div>

    <div class="config-group">
        <div class="config-item">
            <label class="config-label">ç‚¹æ’­/ç›´æ’­å®Œæ•´åœ°å€</label>
            <input type="text" class="config-input" id="videoUrl" placeholder="m3u8/mp4">
        </div>
    </div>

    <div class="stats-group">
        <div class="stats-card">
            <div class="stats-label">æ€»è¯·æ±‚</div>
            <div class="stats-value" id="totalRequest">0</div>
        </div>
        <div class="stats-card">
            <div class="stats-label">æ€»æˆåŠŸ</div>
            <div class="stats-value" id="totalSuccess">0</div>
        </div>
        <div class="stats-card">
            <div class="stats-label">æ€»å¤±è´¥</div>
            <div class="stats-value" id="totalFailed">0</div>
        </div>
    </div>

    <div class="video-player">
        <!-- é¢„åŠ è½½åŠ¨ç”»è¦†ç›–å±‚ -->
        <div class="preload-overlay" id="preloadOverlay">
            <div class="preload-animation"></div>
        </div>
        <video id="video" preload="metadata" disablePictureInPicture playsinline>
            ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒHTML5è§†é¢‘æ’­æ”¾ï¼Œè¯·å‡çº§æµè§ˆå™¨
        </video>
        <!-- ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ–°æ ·å¼æ§åˆ¶æ  -->
        <div class="video-controls">
            <div class="control-top">
                <div class="time-display" id="timeShow">0:00 / 0:00</div>
                <div class="control-buttons">
                    <button class="control-btn volume-btn" id="volumeBtn">ğŸ”Š</button>
                    <button class="control-btn fullscreen-btn" id="fullScreenBtn">â›¶</button>
                    <button class="control-btn more-btn" id="moreBtn">â‹®</button>
                </div>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-now" id="progressNow"></div>
            </div>
        </div>
        <!-- ä¸‰ç‚¹èœå• -->
        <div class="more-menu" id="moreMenu">
            <div class="menu-item download-item">ğŸ“¥ ä¸‹è½½</div>
            <div class="speed-options">
                <div class="speed-option" data-speed="0.5">0.5x</div>
                <div class="speed-option active" data-speed="1">1x</div>
                <div class="speed-option" data-speed="1.5">1.5x</div>
                <div class="speed-option" data-speed="2">2x</div>
                <div class="speed-option" data-speed="3">3x</div>
            </div>
        </div>
    </div>
    <!-- å…¨å±ä¸“å±æ©™è‰²æš‚åœ/æ’­æ”¾æŒ‰é’® -->
    <button class="fullscreen-pause-btn" id="fullscreenPauseBtn">â¸ï¸</button>

    <div class="btn-group">
        <button class="btn btn-start" id="loadVideo">åŠ è½½æ’­æ”¾</button>
        <button class="btn btn-toggle" id="togglePlay" disabled>ç»§ç»­/åœæ­¢æ’­æ”¾</button>
    </div>

    <!-- 1å·æ¡†ï¼šæ—¥å¿—é¢æ¿ -->
    <div class="log-panel" id="logPanel">
        [åˆå§‹åŒ–] æ’­æ”¾å™¨å·²å°±ç»ªï¼Œæ­£åœ¨å‡†å¤‡æ’­æ”¾ç¯å¢ƒ...
    </div>

    <!-- 2å·æ¡†ï¼šTSç‰‡æ®µåˆ—è¡¨é¢æ¿ -->
    <div class="ts-list" id="tsList" style="display: none;">
        <div id="tsItems"></div>
    </div>

    <!-- å›½å†…CDNåŠ è½½HLS.js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/hls.js/1.4.14/hls.min.js"></script>
    <script>
        // DOMå…ƒç´ 
        const videoUrl = document.getElementById('videoUrl');
        const loadVideo = document.getElementById('loadVideo');
        const togglePlay = document.getElementById('togglePlay');
        const video = document.getElementById('video');
        const progressBar = document.getElementById('progressBar');
        const progressNow = document.getElementById('progressNow');
        const timeShow = document.getElementById('timeShow');
        const fullScreenBtn = document.getElementById('fullScreenBtn');
        const volumeBtn = document.getElementById('volumeBtn');
        const moreBtn = document.getElementById('moreBtn');
        const moreMenu = document.getElementById('moreMenu');
        const fullscreenPauseBtn = document.getElementById('fullscreenPauseBtn');
        const player = document.querySelector('.video-player');
        const totalRequest = document.getElementById('totalRequest');
        const totalSuccess = document.getElementById('totalSuccess');
        const totalFailed = document.getElementById('totalFailed');
        const logPanel = document.getElementById('logPanel');
        const tsList = document.getElementById('tsList');
        const tsItems = document.getElementById('tsItems');
        const preloadOverlay = document.getElementById('preloadOverlay');
        // å…¨å±€å˜é‡
        let globalTSUrls = [];
        let globalTSExtinf = [];
        let currentHls = null;
        let isLive = false;
        let originalUrl = '';
        let hlsLoaded = false;
        let isMuted = false;
        let videoDuration = 0; // å­˜å‚¨è§†é¢‘æ€»æ—¶é•¿
        // æ—¥å¿—è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶
        let logAutoScroll = true;
        let logScrollTimer = null;
        // ç»Ÿè®¡æ•°æ®
        let stats = {
            request: 0,
            success: 0,
            failed: 0
        };

        // HLS.jsåŠ è½½è¶…æ—¶æ£€æµ‹
        let hlsLoadTimer = setTimeout(() => {
            if (!window.Hls) {
                hlsLoaded = false;
                addLog('ç¯å¢ƒåŠ è½½è¶…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºåŸç”Ÿæ’­æ”¾ç¯å¢ƒ', 'warn');
                initPlayer();
            }
        }, 5000);

        // åˆå§‹åŒ–æ£€æŸ¥HLS.jsåŠ è½½çŠ¶æ€
        window.addEventListener('load', () => {
            clearTimeout(hlsLoadTimer);
            hlsLoaded = !!window.Hls;
            initPlayer();
        });

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initPlayer() {
            if (hlsLoaded) {
                addLog('HLSç¯å¢ƒå·²æ­å»ºå®Œæˆ', 'success');
            } else {
                addLog('HLS.jsæœªåŠ è½½ï¼Œå°†ä½¿ç”¨åŸç”ŸHTML5è§†é¢‘æ’­æ”¾', 'info');
            }
            addLog('æ’­æ”¾å™¨å·²å°±ç»ªï¼Œæ”¯æŒM3U8ç›´æ’­/ç‚¹æ’­ã€MP4æ ¼å¼', 'info');
        }

        // æ—¥å¿—æ»šåŠ¨äº‹ä»¶
        logPanel.addEventListener('scroll', () => {
            logAutoScroll = false;
            clearTimeout(logScrollTimer);
            logScrollTimer = setTimeout(() => {
                logAutoScroll = true;
                logPanel.scrollTop = logPanel.scrollHeight;
            }, 30000);
        });

        // æ˜¾ç¤ºé¢„åŠ è½½åŠ¨ç”»
        function showPreload() {
            preloadOverlay.style.opacity = '1';
            preloadOverlay.style.display = 'flex';
        }

        // éšè—é¢„åŠ è½½åŠ¨ç”»
        function hidePreload() {
            preloadOverlay.style.opacity = '0';
            setTimeout(() => {
                preloadOverlay.style.display = 'none';
            }, 500);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logPanel.innerHTML = '[åˆå§‹åŒ–] æ’­æ”¾å™¨å·²å°±ç»ªï¼Œæ”¯æŒM3U8ç›´æ’­/ç‚¹æ’­ã€MP4æ ¼å¼';
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¯«ç§’æ—¶é—´
        function formatMsTime() {
            const now = new Date();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const s = now.getSeconds().toString().padStart(2, '0');
            const ms = now.getMilliseconds().toString().padStart(3, '0');
            return `${h}:${m}:${s}.${ms}`;
        }

        // ä¼˜åŒ–æ—¶é•¿æ ¼å¼åŒ–ï¼Œå…¼å®¹NaNå’ŒInfinity
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds <= 0) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        // æ ¼å¼åŒ–EXTINFæ—¶é•¿ä¸º#EXTINF:X.000æ ‡å‡†æ ¼å¼
        function formatExtinf(time) {
            if (isNaN(time) || time <= 0) return '#EXTINF:0.000';
            return `#EXTINF:${parseFloat(time).toFixed(3)}`;
        }

        // å¤åˆ¶TSé“¾æ¥
        function copyTSLink(url, btn) {
            const oldTip = btn.parentNode.querySelector('.copy-tip');
            if (oldTip) oldTip.remove();
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showCopyTip(btn, 'å¤åˆ¶æˆåŠŸ');
                }).catch(err => {
                    fallbackCopyTextToClipboard(url, btn, err);
                });
            } else {
                fallbackCopyTextToClipboard(url, btn);
            }
        }

        // å¤åˆ¶é™çº§æ–¹æ¡ˆ
        function fallbackCopyTextToClipboard(url, btn, err) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'absolute';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyTip(btn, 'å¤åˆ¶æˆåŠŸ');
                if (err) addLog(`å‰ªè´´æ¿APIå¤±æ•ˆï¼Œå·²ä½¿ç”¨é™çº§æ–¹æ¡ˆï¼š${err.message}`, 'warn');
            } catch (fallbackErr) {
                showCopyTip(btn, 'å¤åˆ¶å¤±è´¥', 'color: #F44336;');
                addLog(`å¤åˆ¶TSé“¾æ¥å¤±è´¥ï¼š${fallbackErr.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æç¤º
        function showCopyTip(btn, text, style = 'color: #4CAF50;') {
            const tip = document.createElement('span');
            tip.className = 'copy-tip';
            tip.innerText = text;
            tip.style = style;
            btn.parentNode.appendChild(tip);
            setTimeout(() => {
                tip.remove();
            }, 2000);
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(text, type = 'info', isTS = false, tsUrl = '', tsIndex = 0) {
            const time = formatMsTime();
            let logClass = '';
            if (type === 'success') logClass = 'color: #4CAF50;';
            if (type === 'error') logClass = 'color: #F44336;';
            if (type === 'warn') logClass = 'color: #FF9800;';

            if (isTS && tsUrl) {
                const logItem = document.createElement('div');
                logItem.className = 'ts-log-item';
                const escapeUrl = tsUrl.replace(/'/g, '\\\'').replace(/"/g, '\\"');
                logItem.innerHTML = `
                    <span>[${time}]</span>
                    <span style="${logClass}">${text}</span>
                    <button class="copy-ts-btn" onclick="copyTSLink('${escapeUrl}', this)">å¤åˆ¶TSé“¾æ¥</button>
                `;
                logPanel.appendChild(logItem);
            } else {
                logPanel.innerHTML += `<br>[${time}] <span style="${logClass}">${text}</span>`;
            }
            if (logAutoScroll) {
                logPanel.scrollTop = logPanel.scrollHeight;
            }
        }

        // ä¼˜åŒ–M3U8ç›´æ’­/ç‚¹æ’­æ£€æµ‹é€»è¾‘
        function detectM3U8Type(m3u8Content) {
            const isVodByTag = /#EXT-X-PLAYLIST-TYPE:VOD/i.test(m3u8Content);
            const hasEndList = /#EXT-X-ENDLIST/i.test(m3u8Content);
            const hasMultipleExtinf = (m3u8Content.match(/#EXTINF:/gi) || []).length >= 2;
            const isVod = isVodByTag || hasEndList || hasMultipleExtinf;
            const isLiveByTag = /#EXT-X-LIVE|#EXT-X-STREAM-INF/i.test(m3u8Content);
            const isLiveByNoEnd = !hasEndList && !isVodByTag && !hasMultipleExtinf;
            return !isVod || (isLiveByTag && !hasMultipleExtinf);
        }

        // è·å–M3U8åŸºç¡€URL
        function getM3U8BaseUrl(fullUrl) {
            const lastSlashIndex = fullUrl.lastIndexOf('/');
            if (lastSlashIndex === -1) return '';
            return fullUrl.substring(0, lastSlashIndex + 1);
        }

        // M3U8è§£æ
        async function parseM3U8() {
            addLog(`å¼€å§‹è§£æM3U8æ–‡ä»¶ï¼š${originalUrl}`, 'info');
            try {
                const response = await fetch(originalUrl, {
                    mode: 'cors',
                    credentials: 'omit',
                    timeout: 15000
                });
                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                const m3u8Content = await response.text();
                isLive = detectM3U8Type(m3u8Content);
                addLog(`M3U8è§£æå®Œæˆï¼Œ${isLive ? 'æ£€æµ‹ä¸ºã€ç›´æ’­æµã€‘ï¼ˆTSå®æ—¶åˆ·æ–°ï¼‰' : 'æ£€æµ‹ä¸ºã€ç‚¹æ’­æµã€‘'}`, 'success');
                
                // ä»M3U8è§£ææ€»æ—¶é•¿
                if (!isLive) {
                    const extinfMatches = m3u8Content.match(/#EXTINF:(\d+\.?\d*)/g);
                    if (extinfMatches) {
                        videoDuration = extinfMatches.reduce((total, match) => {
                            return total + parseFloat(match.replace('#EXTINF:', ''));
                        }, 0);
                        timeShow.innerText = `0:00 / ${formatTime(videoDuration)}`;
                        addLog(`è§£æM3U8æ€»æ—¶é•¿ï¼š${formatTime(videoDuration)}`, 'info');
                    }
                }
                
                const lines = m3u8Content.split('\n').map(line => line.trim()).filter(line => line);
                const tsUrls = [];
                const tsExtinfList = [];
                const baseUrl = getM3U8BaseUrl(originalUrl);
                let currentExtinf = 0;
                const extinfReg = /#EXTINF:(\d+\.?\d*)/i;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const extinfMatch = line.match(extinfReg);
                    if (extinfMatch) {
                        currentExtinf = parseFloat(extinfMatch[1]);
                        if (i + 1 < lines.length && !lines[i + 1].startsWith('#')) {
                            let tsUrl = lines[i + 1];
                            if (!tsUrl.startsWith('http') && baseUrl) {
                                tsUrl = baseUrl + tsUrl;
                            }
                            if (!tsUrls.includes(tsUrl)) {
                                tsUrls.push(tsUrl);
                                tsExtinfList.push(currentExtinf || 0);
                            }
                            i++;
                        }
                        continue;
                    }
                    if (!line.startsWith('#') && (line.includes('.ts') || line.includes('.m3u8'))) {
                        let tsUrl = line;
                        if (!tsUrl.startsWith('http') && baseUrl) {
                            tsUrl = baseUrl + tsUrl;
                        }
                        if (!tsUrls.includes(tsUrl)) {
                            tsUrls.push(tsUrl);
                            tsExtinfList.push(currentExtinf || 0);
                        }
                        currentExtinf = 0;
                    }
                }

                const uniqueTsMap = new Map();
                tsUrls.forEach((url, idx) => uniqueTsMap.set(url, tsExtinfList[idx]));
                const uniqueTsUrls = Array.from(uniqueTsMap.keys());
                const uniqueExtinf = Array.from(uniqueTsMap.values());
                
                if (isLive) {
                    uniqueTsUrls.forEach((url, idx) => {
                        if (!globalTSUrls.includes(url)) {
                            globalTSUrls.push(url);
                            globalTSExtinf.push(uniqueExtinf[idx]);
                        }
                    });
                } else {
                    globalTSUrls = uniqueTsUrls;
                    globalTSExtinf = uniqueExtinf;
                }

                if (uniqueTsUrls.length > 0) {
                    renderTSList(globalTSUrls, globalTSExtinf);
                    if (isLive) {
                        uniqueTsUrls.forEach((tsUrl, idx) => {
                            const tsSeq = globalTSUrls.findIndex(u => u === tsUrl) + 1;
                            const extinfTime = uniqueExtinf[idx];
                            const extinfText = formatExtinf(extinfTime);
                            addLog(`ã€TS-${tsSeq}ã€‘${extinfText}ï¼Œç›´æ’­å®æ—¶åˆ†ç‰‡ï¼š${tsUrl}`, 'info', true, tsUrl, tsSeq);
                        });
                    } else {
                        uniqueTsUrls.forEach((tsUrl, idx) => {
                            const tsSeq = idx + 1;
                            const extinfTime = uniqueExtinf[idx];
                            const extinfText = formatExtinf(extinfTime);
                            addLog(`ã€TS-${tsSeq}ã€‘${extinfText}ï¼Œé“¾æ¥ï¼š${tsUrl}`, 'info', true, tsUrl, tsSeq);
                        });
                    }
                } else {
                    addLog(`${isLive ? 'ã€ç›´æ’­æµã€‘' : 'ã€ç‚¹æ’­æµã€‘'}æœªæå–åˆ°TSåˆ†ç‰‡`, 'warn');
                }
                return uniqueTsUrls;
            } catch (error) {
                addLog(`M3U8è§£æå¤±è´¥ï¼š${error.message}`, 'error');
                isLive = false;
                globalTSUrls = [];
                globalTSExtinf = [];
                hidePreload();
                return [];
            }
        }

        // æ¸²æŸ“TSåˆ—è¡¨
        function renderTSList(tsUrls, tsExtinf) {
            tsList.style.display = 'block';
            if (!isLive) {
                tsItems.innerHTML = '';
            }
            const startIndex = isLive ? tsItems.children.length : 0;
            for (let i = startIndex; i < tsUrls.length; i++) {
                const url = tsUrls[i];
                const extinfTime = tsExtinf[i] || 0;
                const extinfText = formatExtinf(extinfTime);
                const item = document.createElement('div');
                item.className = 'ts-item';
                const escapeUrl = url.replace(/'/g, '\\\'').replace(/"/g, '\\"');
                item.innerHTML = `
                    <span class="ts-index">${i + 1}</span>
                    <span class="ts-url" title="${extinfText}">${url}</span>
                    <span class="ts-extinf">${extinfText}</span>
                    <button class="copy-ts-btn" onclick="copyTSLink('${escapeUrl}', this)">å¤åˆ¶é“¾æ¥</button>
                `;
                tsItems.appendChild(item);
            }
        }

        // é”€æ¯HLSå®ä¾‹
        function destroyHls() {
            if (currentHls) {
                currentHls.destroy();
                currentHls = null;
            }
        }

        // åŠ è½½æ’­æ”¾æ ¸å¿ƒé€»è¾‘
        loadVideo.addEventListener('click', async () => {
            originalUrl = videoUrl.value.trim();
            if (!originalUrl) {
                addLog('é”™è¯¯ï¼šè¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘/ç›´æ’­åœ°å€', 'error');
                return;
            }
            showPreload();
            clearLog();
            destroyHls();
            stats.request++;
            updateStats();
            video.pause();
            progressNow.style.width = '0%';
            timeShow.innerText = '0:00 / 0:00';
            videoDuration = 0; // é‡ç½®æ—¶é•¿
            if (!isLive) {
                tsList.style.display = 'none';
                tsItems.innerHTML = '';
            }
            globalTSUrls = [];
            globalTSExtinf = [];
            isLive = false;
            togglePlay.disabled = true;
            logAutoScroll = true;
            clearTimeout(logScrollTimer);

            video.style.display = 'block';

            addLog(`è¯·æ±‚åŠ è½½ï¼š${originalUrl}`, 'info');

            const isM3U8 = originalUrl.toLowerCase().endsWith('.m3u8') || originalUrl.toLowerCase().includes('.m3u8?');
            let primaryPlaySuccess = false;

            if (isM3U8) {
                addLog('æ£€æµ‹åˆ°M3U8æ ¼å¼ï¼Œå°è¯•è§£ææ’­æ”¾', 'info');
                const tsUrls = await parseM3U8();
                if (tsUrls.length === 0 && !isLive) {
                    addLog('M3U8è§£æè¿”å›ç©ºåˆ†ç‰‡åˆ—è¡¨ï¼Œå°è¯•åŸç”Ÿæ’­æ”¾', 'warn');
                    playWithNative();
                    hidePreload();
                    return;
                }

                if (hlsLoaded && window.Hls.isSupported()) {
                    try {
                        currentHls = new Hls({
                            liveSyncDuration: 3,
                            liveMaxLatencyDuration: 15,
                            enableWorker: true,
                            maxBufferLength: isLive ? 10 : 30,
                            manifestLoadingRetryDelay: 2000,
                            fragmentLoadingRetryDelay: 2000,
                            maxBufferLength: 30,
                            maxMaxBufferLength: 600,
                            manifestLoadingMaxRetry: 2,
                            fragmentLoadingMaxRetry: 2,
                            lowLatencyMode: isLive
                        });

                        currentHls.detachMedia(video);
                        currentHls.loadSource(originalUrl);
                        currentHls.attachMedia(video);
                        
                        // HLS.jså¤šäº‹ä»¶ç›‘å¬æ—¶é•¿
                        currentHls.on(Hls.Events.LEVEL_LOADED, (event, data) => {
                            if (data.details && data.details.totalDuration) {
                                videoDuration = data.details.totalDuration;
                                timeShow.innerText = `0:00 / ${formatTime(videoDuration)}`;
                                addLog(`HLSè·å–æ€»æ—¶é•¿ï¼š${formatTime(videoDuration)}`, 'info');
                            }
                        });

                        currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                            primaryPlaySuccess = true;
                            togglePlay.disabled = false;
                            video.play().then(() => {
                                addLog(`${isLive ? 'ç›´æ’­æµ' : 'ç‚¹æ’­æµ'}æ’­æ”¾æˆåŠŸ`, 'success');
                                hidePreload();
                            }).catch(err => {
                                addLog(`è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®`, 'warn');
                                hidePreload();
                                togglePlay.disabled = false;
                            });
                            if (isLive) {
                                progressBar.style.pointerEvents = 'auto';
                                addLog('ã€ç›´æ’­æµã€‘å·²å¯ç”¨è¿›åº¦æ¡ï¼ŒTSåˆ†ç‰‡å®æ—¶åˆ·æ–°ä¸­', 'info');
                                setInterval(async () => {
                                    if (isLive && !video.paused) {
                                        await parseM3U8();
                                    }
                                }, 5000);
                            } else {
                                progressBar.style.pointerEvents = 'auto';
                            }
                        });

                        currentHls.on(Hls.Events.ERROR, (event, data) => {
                            addLog(`HLSæ’­æ”¾å¤±è´¥ï¼š${data.details}ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºåŸç”Ÿæ’­æ”¾`, 'error');
                            destroyHls();
                            playWithNative();
                        });

                        currentHls.on(Hls.Events.FRAG_LOADED, (event, data) => {
                            if (!data.frag || !data.frag.url) return;
                            const tsIndex = globalTSUrls.findIndex(u => u === data.frag.url) + 1 || globalTSUrls.length + 1;
                            if (!globalTSUrls.includes(data.frag.url)) {
                                globalTSUrls.push(data.frag.url);
                                globalTSExtinf.push(parseFloat(data.frag.duration) || 0);
                                renderTSList(globalTSUrls, globalTSExtinf);
                            }
                            const extinfTime = globalTSExtinf[tsIndex - 1] || parseFloat(data.frag.duration) || 0;
                            const extinfText = formatExtinf(extinfTime);
                            addLog(`ã€TS-${tsIndex}ã€‘${extinfText}ï¼Œ${isLive ? 'ç›´æ’­å®æ—¶åŠ è½½' : 'åŠ è½½å®Œæˆ'}ï¼š${data.frag.url}`, 'success', true, data.frag.url, tsIndex);
                            stats.success++;
                            updateStats();
                        });
                    } catch (hlsError) {
                        addLog(`HLSåˆå§‹åŒ–å¤±è´¥ï¼š${hlsError.message}ï¼Œåˆ‡æ¢ä¸ºåŸç”Ÿæ’­æ”¾`, 'error');
                        destroyHls();
                        playWithNative();
                    }
                } else {
                    playWithNative();
                }
            } else {
                addLog('æ£€æµ‹ä¸ºæ™®é€šè§†é¢‘æ ¼å¼ï¼Œå¼€å§‹åŠ è½½', 'info');
                video.src = originalUrl;
                video.onloadedmetadata = function() {
                    videoDuration = video.duration;
                    addLog(`æ™®é€šè§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿ï¼š${formatTime(videoDuration)}`, 'success');
                    timeShow.innerText = `0:00 / ${formatTime(videoDuration)}`;
                };
                video.load();
                video.play().then(() => {
                    primaryPlaySuccess = true;
                    togglePlay.disabled = false;
                    addLog('æ™®é€šè§†é¢‘æ’­æ”¾æˆåŠŸ', 'success');
                    stats.success++;
                    updateStats();
                    hidePreload();
                }).catch(err => {
                    addLog('æ™®é€šè§†é¢‘æ’­æ”¾å¤±è´¥ï¼š' + err.message, 'error');
                    stats.failed++;
                    updateStats();
                    hidePreload();
                });
            }

            // å¼ºåˆ¶å®æ—¶æ›´æ–°æ—¶é—´ä¸è¿›åº¦
            video.addEventListener('timeupdate', () => {
                const currentTime = video.currentTime;
                if (videoDuration > 0) {
                    timeShow.innerText = `${formatTime(currentTime)} / ${formatTime(videoDuration)}`;
                    const progressRate = (currentTime / videoDuration) * 100;
                    progressNow.style.width = `${progressRate}%`;
                } else if (video.duration > 0) {
                    // é™çº§æ–¹æ¡ˆï¼šç›´æ¥ä»videoå…ƒç´ è·å–æ—¶é•¿
                    videoDuration = video.duration;
                    timeShow.innerText = `${formatTime(currentTime)} / ${formatTime(videoDuration)}`;
                    const progressRate = (currentTime / videoDuration) * 100;
                    progressNow.style.width = `${progressRate}%`;
                }
            });
        });

        // åŸç”Ÿæ’­æ”¾M3U8
        function playWithNative() {
            addLog('ä½¿ç”¨åŸç”ŸHTML5è§†é¢‘æ’­æ”¾', 'info');
            video.src = originalUrl;
            video.load();
            video.play().then(() => {
                togglePlay.disabled = false;
                addLog('åŸç”Ÿæ’­æ”¾æˆåŠŸ', 'success');
                hidePreload();
            }).catch(err => {
                addLog('åŸç”Ÿæ’­æ”¾å¤±è´¥ï¼š' + err.message, 'error');
                stats.failed++;
                updateStats();
                hidePreload();
            });
        }

        // æ’­æ”¾/æš‚åœåˆ‡æ¢
        togglePlay.addEventListener('click', () => {
            if (video.paused) {
                video.play().then(() => {
                    fullscreenPauseBtn.innerText = 'â¸ï¸';
                    addLog(`${isLive ? 'ç›´æ’­æµ' : 'è§†é¢‘'}ç»§ç»­æ’­æ”¾`, 'success');
                }).catch(err => {
                    addLog(`æ’­æ”¾å¤±è´¥ï¼š${err.message}ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™`, 'error');
                });
            } else {
                video.pause();
                fullscreenPauseBtn.innerText = 'â–¶ï¸';
                addLog(`${isLive ? 'ç›´æ’­æµ' : 'è§†é¢‘'}å·²æš‚åœ`, 'info');
            }
        });

        // éŸ³é‡åˆ‡æ¢
        volumeBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            video.muted = isMuted;
            volumeBtn.innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            addLog(`å·²${isMuted ? 'é™éŸ³' : 'å–æ¶ˆé™éŸ³'}`, 'info');
        });

        // å…¨å±åˆ‡æ¢
        fullScreenBtn.addEventListener('click', () => {
            if (!video.src) return;
            if (document.fullscreenElement) {
                document.exitFullscreen();
                fullScreenBtn.innerText = 'â›¶';
                addLog('ç”¨æˆ·é€€å‡ºå…¨å±', 'info');
            } else {
                player.requestFullscreen().catch(err => {
                    addLog(`å…¨å±å¤±è´¥ï¼š${err.message}`, 'error');
                });
                fullScreenBtn.innerText = 'âŒ';
                addLog('ç”¨æˆ·è¿›å…¥å…¨å±', 'info');
            }
        });

        // æ›´å¤šæŒ‰é’®
        moreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            moreMenu.classList.toggle('active');
        });

        // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ›´å¤šèœå•
        document.addEventListener('click', () => {
            moreMenu.classList.remove('active');
        });

        // å€é€Ÿé€‰æ‹©
        document.querySelectorAll('.speed-option').forEach(option => {
            option.addEventListener('click', () => {
                const speed = parseFloat(option.dataset.speed);
                video.playbackRate = speed;
                document.querySelectorAll('.speed-option').forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                addLog(`å·²åˆ‡æ¢å€é€Ÿä¸º${speed}x`, 'info');
                moreMenu.classList.remove('active');
            });
        });

        // ä¸‹è½½åŠŸèƒ½
        document.querySelector('.download-item').addEventListener('click', () => {
            addLog('è§¦å‘è§†é¢‘ä¸‹è½½åŠŸèƒ½', 'info');
            // å¯åœ¨æ­¤å¤„æ·»åŠ ä¸‹è½½é€»è¾‘
            moreMenu.classList.remove('active');
        });

        // å…¨å±ä¸“å±æ©™è‰²æ’­æ”¾/æš‚åœæŒ‰é’®ç‚¹å‡»
        fullscreenPauseBtn.addEventListener('click', () => {
            if (!video.src) return;
            if (video.paused) {
                video.play().then(() => {
                    fullscreenPauseBtn.innerText = 'â¸ï¸';
                    addLog(`${isLive ? 'ç›´æ’­æµ' : 'è§†é¢‘'}ç»§ç»­æ’­æ”¾`, 'success');
                }).catch(err => {
                    addLog(`æ’­æ”¾å¤±è´¥ï¼š${err.message}ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™`, 'error');
                });
            } else {
                video.pause();
                fullscreenPauseBtn.innerText = 'â–¶ï¸';
                addLog(`${isLive ? 'ç›´æ’­æµ' : 'è§†é¢‘'}å·²æš‚åœ`, 'info');
            }
        });

        // è¿›åº¦æ¡è·³è½¬
        progressBar.addEventListener('click', (e) => {
            if (isLive || !videoDuration) return;
            const barX = e.offsetX / progressBar.offsetWidth;
            video.currentTime = barX * videoDuration;
            addLog(`ç”¨æˆ·è·³è½¬è¿›åº¦åˆ°ï¼š${formatTime(video.currentTime)}`, 'info');
        });

        // å…¨å±çŠ¶æ€ç›‘å¬
        document.addEventListener('fullscreenchange', () => {
            fullScreenBtn.innerText = document.fullscreenElement ? 'âŒ' : 'â›¶';
            if (document.fullscreenElement) {
                fullscreenPauseBtn.innerText = video.paused ? 'â–¶ï¸' : 'â¸ï¸';
            }
        });

        // è§†é¢‘åŠ è½½é”™è¯¯äº‹ä»¶
        video.addEventListener('error', () => {
            addLog(`æ’­æ”¾å¤±è´¥ï¼šé”™è¯¯ç ${video.error.code}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š${video.error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            stats.failed++;
            updateStats();
            hidePreload();
        });

        // è§†é¢‘æ’­æ”¾ç»“æŸ
        video.addEventListener('ended', () => {
            if (!isLive) {
                progressNow.style.width = '0%';
                video.currentTime = 0;
                timeShow.innerText = `0:00 / ${formatTime(videoDuration)}`;
                addLog('ç‚¹æ’­è§†é¢‘æ’­æ”¾ç»“æŸï¼Œå·²é‡ç½®æ’­æ”¾ä½ç½®', 'info');
            }
        });

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            totalRequest.innerText = stats.request;
            totalSuccess.innerText = stats.success;
            totalFailed.innerText = stats.failed;
        }

        // å›è½¦è§¦å‘åŠ è½½
        videoUrl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') loadVideo.click();
        });
    </script>
</body>
</html>
